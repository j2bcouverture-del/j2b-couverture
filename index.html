<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>J2B Couverture | Couvreur √† Toul</title>
  <meta name="description" content="J2B Couverture : r√©novation de toiture, r√©paration de fuites, zinguerie, nettoyage/d√©moussage. Intervention : 54, 55, 57, 88. Devis gratuit.">

  <style>
    :root{
      --bg:#ffffff;
      --card:#f8fafc;
      --text:#0f172a;
      --muted:#475569;
      --border:#e5e7eb;
      --shadow:0 12px 30px rgba(2,6,23,.10);
      --radius:16px;
      --blue:#2563eb;
      --red:#dc2626;
      --max:1120px;
    }

    *{box-sizing:border-box}
    html{scroll-behavior:smooth}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    a{color:inherit;text-decoration:none}
    .container{width:min(var(--max),92%);margin:auto}
    .muted{color:var(--muted)}
    .small{font-size:.95rem}
    p{line-height:1.65;margin:0 0 12px}
    h1,h2,h3{line-height:1.15}
    h1{font-size:clamp(2rem,4vw,3rem);margin:0 0 12px}
    h2{margin:0 0 10px}
    h3{margin:0 0 8px}

    header{
      position:sticky; top:0; z-index:50;
      background:#fff;
      border-bottom:1px solid var(--border);
    }
    .nav{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:14px 0;
    }
    .brand{display:flex;align-items:center;gap:12px;min-width:0}
    .brand img{height:64px;width:auto;display:block}

    .btn{
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
      padding:12px 16px;border-radius:var(--radius);
      font-weight:900;border:0;cursor:pointer;
      box-shadow:var(--shadow);white-space:nowrap;
    }
    .btn.blue{background:var(--blue);color:#fff}
    .btn.red{background:var(--red);color:#fff}
    .btn.ghost{background:#fff;border:1px solid var(--border);box-shadow:none}

    /* Menu hamburger */
    .menuWrap{position:relative}
    .menuBtn{
      width:46px;height:46px;background:var(--blue);
      border-radius:14px;border:none;
      display:flex;flex-direction:column;justify-content:center;align-items:center;gap:5px;
      cursor:pointer;box-shadow:var(--shadow);
    }
    .menuBtn span{width:22px;height:3px;background:#fff;border-radius:3px}
    .menuPanel{
      position:absolute;right:0;top:calc(100% + 10px);
      width:min(300px, 86vw);
      background:#fff;border:1px solid var(--border);
      border-radius:16px;box-shadow:var(--shadow);
      padding:10px;display:none;z-index:200;
    }
    .menuPanel.open{display:block}
    .menuItem{display:block;padding:12px;border-radius:12px;font-weight:900;color:var(--text)}
    .menuItem:hover{background:var(--card)}

    /* Hero */
    .hero{padding:70px 0 34px;background:linear-gradient(to bottom,#fff,#f8fafc)}
    .heroGrid{display:grid;grid-template-columns:1.2fr .8fr;gap:18px;align-items:start}
    .cta{display:flex;gap:12px;flex-wrap:wrap;margin-top:18px}
    .badges{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
    .badge{background:#fff;border:1px solid var(--border);border-radius:999px;padding:8px 10px;font-weight:900;color:var(--muted)}

    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:18px;box-shadow:var(--shadow)}
    .section{padding:56px 0}
    .section.alt{background:#f1f5f9}

    .grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-top:18px}
    .tile{background:#fff;border:1px solid var(--border);border-radius:var(--radius);padding:18px;box-shadow:var(--shadow)}
    .tile p{margin:0;color:var(--muted)}

    .split{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:18px}
    .list{margin:10px 0 0;padding-left:18px}
    .list li{margin:6px 0}

    /* Galerie */
    .gallery{display:grid;grid-template-columns:repeat(2, minmax(0, 1fr));gap:14px;margin-top:18px}
    .gallery img{
      width:100%;height:auto;aspect-ratio: 4 / 3;object-fit:cover;
      border-radius:12px;border:1px solid var(--border);
      box-shadow:0 8px 20px rgba(0,0,0,0.08);
      background:#fff;display:block;
    }
    @media (min-width: 900px){ .gallery{ grid-template-columns:repeat(3, minmax(0, 1fr)); } }
    @media (max-width: 420px){ .gallery{ grid-template-columns:1fr; } .gallery img{ aspect-ratio: 16 / 10; } }

    /* Form */
    .form{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:16px}
    label{display:flex;flex-direction:column;gap:6px;font-weight:900}
    input,textarea{padding:12px;border-radius:12px;border:1px solid var(--border);font-family:inherit;background:#fff}
    input:focus,textarea:focus{outline:none;border-color:rgba(37,99,235,.55)}
    .full{grid-column:1/-1}

    /* ===== Simulateur (masque invisible + recoloration zone) ===== */
    .simBar{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .simLabel{font-weight:900}
    .simSwatches{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .swatchBtn{
      border:1px solid var(--border);
      background:#fff;
      border-radius:999px;
      padding:10px 12px;
      font-weight:900;
      cursor:pointer;
    }
    .swatchBtn.active{outline:3px solid rgba(37,99,235,.25);border-color: rgba(37,99,235,.35)}
    .simRow{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-top:10px}
    .simRange{flex:1;min-width:180px}
    .simCanvasWrap{
      border:1px solid var(--border);
      border-radius: var(--radius);
      background:#fff;
      overflow:hidden;
      box-shadow: var(--shadow);
      margin-top:14px;
      position:relative;
    }
    #simCanvas,#maskCanvas{width:100%;height:auto;display:block}
    /* IMPORTANT : masque invisible => plus de ‚Äútrait blanc‚Äù */
    #maskCanvas{
      position:absolute;left:0;top:0;
      touch-action:none;
      cursor:crosshair;
      opacity:0;              /* cache le masque */
      pointer-events:auto;    /* mais on peut dessiner */
    }

    .simHint{
      margin-top:10px;
      padding:10px 12px;
      border:1px solid var(--border);
      border-radius:12px;
      background:#fff;
      color:var(--muted);
      font-weight:700;
    }

    footer{background:#0f172a;color:#fff;padding:26px 0;margin-top:40px}
    footer a{color:#fff;text-decoration:underline}

    .call{
      position:fixed;right:16px;bottom:16px;
      background:var(--red);color:#fff;
      padding:14px 18px;border-radius:999px;
      font-weight:1000;box-shadow:var(--shadow);z-index:60;
    }

    @media(max-width:980px){
      .heroGrid,.grid3,.split,.form{grid-template-columns:1fr}
      .btn{width:100%}
      .brand img{height:54px}
    }
  </style>
</head>

<body>

<header>
  <nav class="nav container">
    <div class="brand">
      <img src="./logo-temp.png?v=1000" alt="J2B Couverture" style="height:70px; width:auto; display:block;">
    </div>

    <div class="menuWrap">
      <button class="menuBtn" id="menuBtn" type="button" aria-expanded="false" aria-controls="menuPanel" aria-label="Menu">
        <span></span><span></span><span></span>
      </button>

      <div class="menuPanel" id="menuPanel">
        <a class="menuItem" href="#services">Services</a>
        <a class="menuItem" href="#zone">Zone</a>
        <a class="menuItem" href="#simulation">Simulateur</a>
        <a class="menuItem" href="#realisations">Photos</a>
        <a class="menuItem" href="#devis">Demande de devis</a>
        <a class="menuItem" href="#contact">Contact</a>
      </div>
    </div>
  </nav>
</header>

<main>

<section class="hero" id="top">
  <div class="container heroGrid">
    <div>
      <h1>R√©novation & r√©paration de toiture √† Toul</h1>
      <p class="muted">
        <strong>J2B Couverture</strong> r√©alise vos travaux de toiture : r√©novation, r√©paration de fuites,
        zinguerie, nettoyage/d√©moussage et entretien.
        <br><strong>Zones :</strong> 54 ‚Ä¢ 55 ‚Ä¢ 57 ‚Ä¢ 88 ‚Äî <strong>Devis gratuit</strong>.
      </p>

      <div class="cta">
        <a class="btn blue" href="#devis">üì© Demander un devis</a>
        <a class="btn red" href="tel:0601462612">üö® Appeler</a>
        <a class="btn ghost" href="#services">Voir les services</a>
      </div>

      <div class="badges">
        <span class="badge">‚úÖ Devis gratuit</span>
        <span class="badge">‚ö° Intervention rapide</span>
        <span class="badge">üß∞ Travail soign√©</span>
      </div>
    </div>

    <div class="card" id="contact">
      <h3>Contact</h3>
      <p class="muted" style="margin:0">
        <strong>T√©l :</strong> 06 01 46 26 12<br>
        <strong>Email :</strong> j2b.couverture@gmail.com<br>
        <strong>Secteurs :</strong> 54 ‚Ä¢ 55 ‚Ä¢ 57 ‚Ä¢ 88
      </p>
      <div style="margin-top:14px;display:flex;gap:10px;flex-wrap:wrap">
        <a class="btn red" href="tel:0601462612">üìû Appeler</a>
        <a class="btn blue" href="#devis">üì© Devis</a>
      </div>
      <p class="muted small" style="margin-top:10px">R√©ponse rapide ‚Ä¢ Conseils clairs ‚Ä¢ Solutions durables</p>
    </div>
  </div>
</section>

<section id="services" class="section alt">
  <div class="container">
    <h2>Nos services</h2>
    <p class="muted">Des prestations claires, adapt√©es √† votre toiture.</p>

    <div class="grid3">
      <div class="tile"><h3>R√©novation de toiture</h3><p>R√©fection partielle ou compl√®te, tuiles, fa√Ætage, reprise d‚Äô√©tanch√©it√©.</p></div>
      <div class="tile"><h3>Fuites & urgences</h3><p>Recherche d‚Äôinfiltration et r√©paration rapide pour s√©curiser votre toit.</p></div>
      <div class="tile"><h3>Zinguerie</h3><p>Goutti√®res, rives, solins, noues ‚Äî finitions durables et propres.</p></div>
      <div class="tile"><h3>Nettoyage / d√©moussage</h3><p>Entretien, nettoyage pour prolonger la dur√©e de vie de la toiture.</p></div>
      <div class="tile"><h3>Isolation</h3><p>Am√©lioration du confort thermique et r√©duction des pertes d‚Äô√©nergie.</p></div>
      <div class="tile"><h3>Entretien</h3><p>Contr√¥le, pr√©vention, petites r√©parations avant gros d√©g√¢ts.</p></div>
    </div>
  </div>
</section>

<section id="zone" class="section">
  <div class="container">
    <h2>Zone d‚Äôintervention</h2>
    <p class="muted">
      Bas√© √† <strong>Toul</strong>, j‚Äôinterviens dans les d√©partements :
      <strong>54</strong> (Meurthe-et-Moselle), <strong>55</strong> (Meuse),
      <strong>57</strong> (Moselle), <strong>88</strong> (Vosges).
    </p>

    <div class="split">
      <div class="card">
        <h3>Ce que vous gagnez</h3>
        <ul class="list">
          <li>Devis clair et gratuit</li>
          <li>Travail soign√©</li>
          <li>Conseils selon votre toiture</li>
          <li>Intervention rapide</li>
        </ul>
      </div>
      <div class="card">
        <h3>Besoin urgent ?</h3>
        <p class="muted">Appelez directement, je vous r√©ponds d√®s que possible.</p>
        <a class="btn red" href="tel:0601462612">üìû 06 01 46 26 12</a>
      </div>
    </div>
  </div>
</section>

<!-- ‚úÖ Simulateur (corrig√©) -->
<section class="section" id="simulation">
  <div class="container">
    <h2>Simulateur couleur (toiture / fa√ßade)</h2>
    <p class="muted">1) Prenez une photo ‚Ä¢ 2) Dessinez la zone ‚Ä¢ 3) Choisissez une teinte (aucun t√©l√©chargement)</p>

    <div class="card">
      <div class="simBar">
        <span class="simLabel">Type :</span>
        <button class="swatchBtn active" type="button" data-preset="terre">Terre cuite</button>
        <button class="swatchBtn" type="button" data-preset="beton">Tuile b√©ton</button>
        <button class="swatchBtn" type="button" data-preset="facade">Fa√ßade</button>

        <label class="btn blue" style="cursor:pointer">
          üì∑ Prendre une photo
          <input id="simFile" type="file" accept="image/*" capture="environment" style="display:none">
        </label>

        <button class="btn ghost" id="maskClear" type="button">Effacer la zone</button>
        <button class="btn ghost" id="simReset" type="button">R√©initialiser</button>
      </div>

      <div class="simSwatches" id="simColors"></div>

      <div class="simRow">
        <span class="simLabel">Intensit√© :</span>
        <input class="simRange" id="simStrength" type="range" min="0" max="70" value="35">
        <span class="muted small" id="simStrengthLabel">35%</span>
      </div>

      <div class="simHint" id="simMsg">
        Dessinez au doigt sur les tuiles (la trace est invisible), puis choisissez une couleur.
      </div>

      <div class="simCanvasWrap">
        <canvas id="simCanvas"></canvas>
        <canvas id="maskCanvas"></canvas>
      </div>
    </div>
  </div>
</section>

<!-- ‚úÖ PHOTOS -->
<section class="section alt" id="realisations">
  <div class="container">
    <h2>Nos r√©alisations</h2>
    <p class="muted">Quelques chantiers r√©alis√©s par <strong>J2B Couverture</strong> dans le 54, 55, 57 et 88.</p>

    <div class="gallery">
      <img src="./Temp1.jpg?v=1" alt="R√©alisation toiture 1" loading="lazy" decoding="async">
      <img src="./temp2.png?v=1" alt="R√©alisation toiture 2" loading="lazy" decoding="async">
      <img src="./temp3.png?v=1" alt="R√©alisation toiture 3" loading="lazy" decoding="async">
      <img src="./temp4.png?v=1" alt="R√©alisation toiture 4" loading="lazy" decoding="async">
      <img src="./temp6.JPG?v=1" alt="R√©alisation toiture 5" loading="lazy" decoding="async">
      <img src="./temp7.png?v=1" alt="R√©alisation toiture 6" loading="lazy" decoding="async">
      <img src="./Temp8.png?v=1" alt="R√©alisation toiture 7" loading="lazy" decoding="async">
    </div>
  </div>
</section>

<!-- ‚úÖ DEVIS -->
<section id="devis" class="section alt">
  <div class="container">
    <h2>Demande de devis</h2>
    <p class="muted">Remplissez le formulaire : l‚Äôapp Mail s‚Äôouvrira avec mon adresse d√©j√† remplie.</p>

    <form class="form" id="devisForm">
      <label>Nom
        <input name="name" required placeholder="Votre nom">
      </label>

      <label>T√©l√©phone
        <input name="phone" required placeholder="Votre num√©ro">
      </label>

      <label class="full">Message
        <textarea name="message" rows="5" required placeholder="Expliquez votre besoin (fuite, r√©novation, nettoyage...)"></textarea>
      </label>

      <button class="btn blue full" type="submit">üì© Envoyer la demande</button>
      <p class="muted small full" id="formHint"></p>
    </form>
  </div>
</section>

</main>

<footer>
  <div class="container">
    <div><strong>J2B Couverture</strong> ‚Äî Toul</div>
    <div style="margin-top:8px">
      T√©l : <a href="tel:0601462612">06 01 46 26 12</a> ‚Ä¢
      Email : <a href="mailto:j2b.couverture@gmail.com">j2b.couverture@gmail.com</a>
    </div>
    <div style="margin-top:8px;opacity:.9;font-size:.95rem">¬© <span id="year"></span> ‚Äî Tous droits r√©serv√©s.</div>
  </div>
</footer>

<a class="call" href="tel:0601462612">üìû Appeler</a>

<script>
  document.getElementById("year").textContent = new Date().getFullYear();

  // Form devis
  (function(){
    const form = document.getElementById("devisForm");
    const hint = document.getElementById("formHint");
    if(!form) return;

    form.addEventListener("submit", function(e){
      e.preventDefault();
      const d = new FormData(form);
      const name = String(d.get("name") || "");
      const phone = String(d.get("phone") || "");
      const message = String(d.get("message") || "");
      const to = "j2b.couverture@gmail.com";
      const subject = encodeURIComponent("Demande de devis - J2B Couverture");
      const body = encodeURIComponent(
        "Nom : " + name + "\n" +
        "T√©l√©phone : " + phone + "\n\n" +
        "Message :\n" + message
      );
      window.location.href = `mailto:${to}?subject=${subject}&body=${body}`;
      hint.textContent = "Si rien ne s‚Äôouvre, v√©rifiez que l‚Äôapp Mail est configur√©e.";
    });
  })();

  // Menu hamburger
  (function(){
    const btn = document.getElementById('menuBtn');
    const panel = document.getElementById('menuPanel');
    if(!btn || !panel) return;

    function close(){
      panel.classList.remove('open');
      btn.setAttribute('aria-expanded','false');
    }
    btn.addEventListener('click', (e)=>{
      e.stopPropagation();
      const open = panel.classList.toggle('open');
      btn.setAttribute('aria-expanded', open ? 'true' : 'false');
    });
    document.addEventListener('click', close);
    panel.querySelectorAll('a').forEach(a => a.addEventListener('click', close));
    document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') close(); });
  })();

  // ===== Simulateur (masque invisible + recoloration zone) =====
  (function(){
    const simCanvas = document.getElementById('simCanvas');
    const maskCanvas = document.getElementById('maskCanvas');
    const file = document.getElementById('simFile');
    const resetBtn = document.getElementById('simReset');
    const maskClearBtn = document.getElementById('maskClear');
    const colorsWrap = document.getElementById('simColors');
    const strength = document.getElementById('simStrength');
    const strengthLabel = document.getElementById('simStrengthLabel');
    const msg = document.getElementById('simMsg');
    const presetBtns = document.querySelectorAll('#simulation .swatchBtn[data-preset]');

    if(!simCanvas || !maskCanvas || !file || !colorsWrap || !strength) return;

    const sctx = simCanvas.getContext('2d');
    const mctx = maskCanvas.getContext('2d');

    const PRESETS = {
      terre: [
        {name:'Terre cuite', hex:'#c2410c'},
        {name:'Rouge', hex:'#b91c1c'},
        {name:'Brun', hex:'#7c2d12'},
        {name:'Ocre', hex:'#92400e'},
        {name:'Noir', hex:'#111827'}
      ],
      beton: [
        {name:'Anthracite', hex:'#111827'},
        {name:'Gris', hex:'#6b7280'},
        {name:'Gris clair', hex:'#9ca3af'},
        {name:'Brun', hex:'#7c2d12'},
        {name:'Rouge', hex:'#b91c1c'}
      ],
      facade: [
        {name:'Blanc cass√©', hex:'#f5f5f4'},
        {name:'Sable', hex:'#d6d3d1'},
        {name:'Taupe', hex:'#a8a29e'},
        {name:'Gris', hex:'#9ca3af'},
        {name:'Bleu', hex:'#1d4ed8'}
      ]
    };

    let currentPreset = 'terre';
    let currentHex = PRESETS[currentPreset][0].hex;

    let baseImg = new Image();
    let hasImage = false;

    // masque dessin√©
    let drawing = false;
    let last = null;
    let hasMask = false; // <- IMPORTANT: √©vite les tests pixels (plus fiable)

    // couche couleur (offscreen)
    const tintCanvas = document.createElement('canvas');
    const tctx = tintCanvas.getContext('2d');

    function deviceScale(){
      return Math.max(1, Math.min(2, window.devicePixelRatio || 1));
    }

    function hexToRgb(hex){
      const h = hex.replace('#','').trim();
      const full = h.length===3 ? h.split('').map(x=>x+x).join('') : h;
      const n = parseInt(full, 16);
      return { r:(n>>16)&255, g:(n>>8)&255, b:n&255 };
    }

    function setCanvasSizeForImage(w, h){
      const maxW = 1400;
      const scale = Math.min(1, maxW / w);
      const cw = Math.round(w * scale);
      const ch = Math.round(h * scale);

      const dpr = deviceScale();

      // visuel
      simCanvas.style.width = '100%';
      simCanvas.style.height = 'auto';
      maskCanvas.style.width = '100%';
      maskCanvas.style.height = 'auto';

      // taille interne
      simCanvas.width = cw * dpr;
      simCanvas.height = ch * dpr;
      maskCanvas.width = cw * dpr;
      maskCanvas.height = ch * dpr;

      // taille offscreen
      tintCanvas.width = simCanvas.width;
      tintCanvas.height = simCanvas.height;

      // scale context
      sctx.setTransform(1,0,0,1,0,0);
      mctx.setTransform(1,0,0,1,0,0);

      // pinceau masque (en pixels internes)
      mctx.lineCap = 'round';
      mctx.lineJoin = 'round';
      mctx.strokeStyle = 'rgba(255,255,255,1)';
      mctx.lineWidth = 46 * dpr; // √©paisseur un peu + pour toiture
    }

    function drawPlaceholder(){
      const dpr = deviceScale();
      const cw = 1100, ch = 650;
      simCanvas.width = cw*dpr; simCanvas.height = ch*dpr;
      maskCanvas.width = cw*dpr; maskCanvas.height = ch*dpr;
      tintCanvas.width = simCanvas.width; tintCanvas.height = simCanvas.height;

      simCanvas.style.width = '100%';
      simCanvas.style.height = 'auto';
      maskCanvas.style.width = '100%';
      maskCanvas.style.height = 'auto';

      sctx.setTransform(1,0,0,1,0,0);
      mctx.setTransform(1,0,0,1,0,0);

      sctx.clearRect(0,0,simCanvas.width,simCanvas.height);
      sctx.fillStyle = '#f1f5f9';
      sctx.fillRect(0,0,simCanvas.width,simCanvas.height);
      sctx.fillStyle = '#475569';
      sctx.font = `${Math.round(28*dpr)}px system-ui, -apple-system, Segoe UI, Roboto, Arial`;
      sctx.fillText('üì∑ Ajoutez une photo pour tester une teinte', 60*dpr, 160*dpr);
      sctx.font = `${Math.round(20*dpr)}px system-ui, -apple-system, Segoe UI, Roboto, Arial`;
      sctx.fillText('Ensuite : dessinez la zone, puis choisissez une couleur.', 60*dpr, 210*dpr);

      mctx.clearRect(0,0,maskCanvas.width,maskCanvas.height);
      hasMask = false;
    }

    function render(){
      sctx.clearRect(0,0,simCanvas.width,simCanvas.height);

      if(!hasImage){
        drawPlaceholder();
        return;
      }

      // 1) base
      sctx.globalCompositeOperation = 'source-over';
      sctx.drawImage(baseImg, 0, 0, simCanvas.width, simCanvas.height);

      if(!hasMask){
        return; // rien dessin√© => pas de recolor
      }

      // 2) tint layer = couleur + masque
      const alpha = Math.max(0, Math.min(0.70, (Number(strength.value)||0)/100));
      const {r,g,b} = hexToRgb(currentHex);

      tctx.clearRect(0,0,tintCanvas.width,tintCanvas.height);
      tctx.globalCompositeOperation = 'source-over';
      tctx.fillStyle = `rgba(${r},${g},${b},${alpha})`;
      tctx.fillRect(0,0,tintCanvas.width,tintCanvas.height);

      // garder la couleur uniquement o√π le masque est dessin√©
      tctx.globalCompositeOperation = 'destination-in';
      tctx.drawImage(maskCanvas, 0, 0);

      // 3) appliquer la couche en multiply (texture tuiles conserv√©e)
      sctx.globalCompositeOperation = 'multiply';
      sctx.drawImage(tintCanvas, 0, 0);

      // revenir normal
      sctx.globalCompositeOperation = 'source-over';
    }

    function buildColors(){
      colorsWrap.innerHTML = '';
      PRESETS[currentPreset].forEach((c, idx)=>{
        const b = document.createElement('button');
        b.type = 'button';
        b.className = 'swatchBtn' + (idx===0 ? ' active' : '');
        b.textContent = c.name;
        b.addEventListener('click', ()=>{
          currentHex = c.hex;
          colorsWrap.querySelectorAll('.swatchBtn').forEach(x=>x.classList.remove('active'));
          b.classList.add('active');
          render();
        });
        colorsWrap.appendChild(b);
      });
      currentHex = PRESETS[currentPreset][0].hex;
      render();
    }

    presetBtns.forEach(btn=>{
      btn.addEventListener('click', ()=>{
        presetBtns.forEach(x=>x.classList.remove('active'));
        btn.classList.add('active');
        currentPreset = btn.getAttribute('data-preset') || 'terre';
        buildColors();
        if(msg) msg.textContent = 'Dessinez la zone, puis choisissez une teinte.';
      });
    });

    strength.addEventListener('input', ()=>{
      strengthLabel.textContent = strength.value + '%';
      render();
    });

    file.addEventListener('change', ()=>{
      const f = file.files && file.files[0];
      if(!f) return;

      const url = URL.createObjectURL(f);
      baseImg = new Image();
      baseImg.onload = ()=>{
        hasImage = true;
        setCanvasSizeForImage(baseImg.naturalWidth, baseImg.naturalHeight);
        mctx.clearRect(0,0,maskCanvas.width,maskCanvas.height);
        hasMask = false;
        render();
        URL.revokeObjectURL(url);
        if(msg) msg.textContent = 'Photo charg√©e ‚úÖ Dessinez la zone (trace invisible), puis choisissez une teinte.';
      };
      baseImg.onerror = ()=>{
        if(msg) msg.textContent = "Impossible de charger la photo. Essaie une autre image.";
      };
      baseImg.src = url;
    });

    function clearMask(){
      mctx.clearRect(0,0,maskCanvas.width,maskCanvas.height);
      last = null;
      hasMask = false;
      render();
      if(msg) msg.textContent = 'Zone effac√©e. Redessinez la toiture.';
    }

    maskClearBtn.addEventListener('click', clearMask);

    resetBtn.addEventListener('click', ()=>{
      hasImage = false;
      file.value = '';
      strength.value = 35;
      strengthLabel.textContent = '35%';
      currentPreset = 'terre';
      presetBtns.forEach(x=>x.classList.remove('active'));
      document.querySelector('#simulation .swatchBtn[data-preset="terre"]')?.classList.add('active');
      buildColors();
      clearMask();
      if(msg) msg.textContent = 'R√©initialis√©. Cliquez sur ‚ÄúPrendre une photo‚Äù.';
      drawPlaceholder();
    });

    function getPos(e){
      const rect = maskCanvas.getBoundingClientRect();
      const xCss = (e.clientX - rect.left);
      const yCss = (e.clientY - rect.top);

      // conversion CSS -> pixels internes canvas
      const sx = maskCanvas.width / rect.width;
      const sy = maskCanvas.height / rect.height;
      return {x: xCss * sx, y: yCss * sy};
    }

    function startDraw(e){
      if(!hasImage){
        if(msg) msg.textContent = 'Ajoutez d‚Äôabord une photo.';
        return;
      }
      drawing = true;
      const p = getPos(e);
      last = p;
      mctx.beginPath();
      mctx.moveTo(p.x, p.y);
      mctx.lineTo(p.x+0.01, p.y+0.01);
      mctx.stroke();
      hasMask = true;
      render();
    }
    function moveDraw(e){
      if(!drawing || !last) return;
      const p = getPos(e);
      mctx.beginPath();
      mctx.moveTo(last.x, last.y);
      mctx.lineTo(p.x, p.y);
      mctx.stroke();
      last = p;
      hasMask = true;
      render();
    }
    function endDraw(){
      drawing = false;
      last = null;
    }

    maskCanvas.addEventListener('pointerdown', (e)=>{ maskCanvas.setPointerCapture?.(e.pointerId); startDraw(e); });
    maskCanvas.addEventListener('pointermove', moveDraw);
    maskCanvas.addEventListener('pointerup', endDraw);
    maskCanvas.addEventListener('pointercancel', endDraw);

    // init
    buildColors();
    drawPlaceholder();
  })();
</script>

</body>
</html>
